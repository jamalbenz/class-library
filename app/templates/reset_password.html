{% extends "base.html" %}
{% block content %}
<div class="card" style="max-width:520px;margin:0 auto;">
  <h2 style="margin:0 0 10px 0;">ğŸ” Reset Password</h2>
  <div class="small" style="margin-bottom:12px;">
    Ø¯Ø®Ù„ password Ø¬Ø¯ÙŠØ¯Ø©. (Ø§Ù„Ø±Ø§Ø¨Ø· Ø®Ø§Øµ ÙŠÙƒÙˆÙ† Ø¬Ø§ÙŠ Ù…Ù† Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„)
  </div>

  <div id="err" class="flash" style="display:none;background:#fee2e2;border-color:#fecaca;"></div>
  <div id="ok" class="flash" style="display:none;background:#dcfce7;border-color:#bbf7d0;"></div>

  <form id="resetForm">
    <label>New password</label>
    <input type="password" id="p1" placeholder="New password..." required minlength="6" />

    <label>Confirm password</label>
    <input type="password" id="p2" placeholder="Confirm..." required minlength="6" />

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
      <button class="btn" type="submit">Update password</button>
      <a class="btn2" href="/login">Back to login</a>
    </div>
  </form>
</div>

<script>
(function(){
  const errBox = document.getElementById("err");
  const okBox  = document.getElementById("ok");

  function showErr(msg){
    errBox.style.display = "block";
    errBox.textContent = "âŒ " + msg;
    okBox.style.display = "none";
  }
  function showOk(msg){
    okBox.style.display = "block";
    okBox.textContent = "âœ… " + msg;
    errBox.style.display = "none";
  }

  // Supabase sends tokens in URL hash: #access_token=...&refresh_token=...&type=recovery
  const hash = window.location.hash || "";
  const params = new URLSearchParams(hash.startsWith("#") ? hash.slice(1) : hash);
  const access_token = params.get("access_token");

  if(!access_token){
    showErr("Ø§Ù„Ø±Ø§Ø¨Ø· Ù†Ø§Ù‚Øµ access_token. ÙØªØ­ /reset Ù…Ù† Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©.");
    return;
  }

  document.getElementById("resetForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const p1 = document.getElementById("p1").value.trim();
    const p2 = document.getElementById("p2").value.trim();

    if(p1.length < 6) return showErr("password Ø®Ø§ØµÙ‡Ø§ ØªÙƒÙˆÙ† 6 Ø­Ø±ÙˆÙ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
    if(p1 !== p2) return showErr("password Ù…Ø§ Ù…ØªØ·Ø§Ø¨Ù‚Ø§Ø´.");

    try{
      const res = await fetch("{{ SUPABASE_URL }}/auth/v1/user", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "apikey": "{{ SUPABASE_ANON_KEY }}",
          "Authorization": "Bearer " + access_token
        },
        body: JSON.stringify({ password: p1 })
      });

      const txt = await res.text();
      if(!res.ok){
        return showErr("Ù…Ø§ Ù‚Ø¯Ø±Ù†Ø§Ø´ Ù†Ø¨Ø¯Ù„Ùˆ password. " + txt);
      }

      showOk("ØªØ¨Ø¯Ù„Ø§Øª password. Ø¯Ø§Ø¨Ø§ Ø¯Ø®Ù„ Ø¨Ù€ login.");
      // optional: ÙŠÙ…Ø³Ø­ Ø§Ù„Ù‡Ø§Ø´ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
      history.replaceState(null, "", "/reset");
    }catch(ex){
      showErr("ÙˆÙ‚Ø¹ Ù…Ø´ÙƒÙ„ ÙØ§Ù„Ø§ØªØµØ§Ù„.");
    }
  });
})();
</script>
{% endblock %}
